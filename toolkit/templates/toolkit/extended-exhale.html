{% extends "base.html" %}
{% load static %}
{% block title %}Extended Exhale{% endblock %}
{% block content %}
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">

<style>
:root {
  --ink:#1f003d;
  --muted:#5e4f79;
  --shadow:0 18px 40px rgba(17,12,40,.08);
  --radius:26px;
  --pill:#e9f0fa;

  --big:#b9b3ff;   /* purple */
  --small:#cfe0ff; /* blue */
}

body {
  background: radial-gradient(circle at 50% 35%, #f9fbff 0%, #ffffff 90%);
  font-family: "DM Sans", sans-serif;
  display:flex;
  flex-direction:column;
  align-items:center;
}

/* Back button */
.back-btn {
  position: fixed;
  top: 70px; 
  left: 22px;
  font-size: 14px;
  padding: 6px 14px;
  background:white;
  border:1px solid #e6e0f5;
  border-radius:999px;
  text-decoration:none;
  color:#3a2c6b;
  box-shadow:0 6px 22px rgba(19,7,63,.06);
}

/* Layout */
.zoom-wrapper{
  transform:scale(0.96);
  transform-origin: top center;
  width:100%;
  min-height: calc(100vh - 60px);
  display:flex;
  justify-content:center;
  align-items:center;
}
main.wrap {
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:32px;
  text-align:center;
}

/* Title pill */
.oval {
  display:flex;
  align-items:center;
  justify-content:center;
  height:70px;
  width:240px;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  color:var(--ink);
  background:var(--pill);
  font-size:19px;
  font-weight:500;
}

/* Sub text */
.sub {
  color:var(--muted);
  font-size:15px;
  max-width:460px;
  line-height:1.6;
}

/* Circle */
.breath-circle {
  width:250px;
  height:250px;
  border-radius:50%;
  background:var(--big);
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  transition:transform ease-in-out, background ease-in-out;
  box-shadow:0 8px 20px rgba(19,7,63,.08);
}

.breath-label {
  font-size:18px;
  color:var(--ink);
  margin-bottom:4px;
}

.breath-number {
  font-size:42px;
  font-weight:600;
  color:var(--ink);
}

/* Buttons */
.actions {
  display:flex;
  gap:60px;
  margin-top:10px;
}
.actions button {
  background:none;
  border:none;
  font-size:16px;
  font-weight:600;
  cursor:pointer;
  color:var(--ink);
}
.actions button:hover { opacity:0.7; }

</style>

<a href="{% url 'toolkit:toolkit-breathing' %}" class="back-btn">‚Üê Back to Breathing</a>

<div class="zoom-wrapper">
  <main class="wrap">

    <div class="oval">Extended Exhale</div>

    <p class="sub">
      Follow the circle as it expands and softens. Notice your shoulders.
    </p>

    <div class="breath-circle" id="circle">
      <div class="breath-label" id="label">Inhale</div>
      <div class="breath-number" id="number">4</div>
    </div>

    <div class="actions">
      <button id="start">Start</button>
      <button id="end-mid" style="display:none;">End</button>
    </div>

  </main>
</div>

<script>
const circle = document.getElementById("circle");
const label = document.getElementById("label");
const number = document.getElementById("number");

const btnStart = document.getElementById("start");
const btnEndMid = document.getElementById("end-mid");

let running = false;
let stopRequested = false;

/* Countdown helper */
async function countdown(sec) {
  for (let i = sec; i >= 1; i--) {
    if (stopRequested) return;
    number.textContent = i;
    await new Promise(res => setTimeout(res, 1000));
  }
}

/* Inhale / Exhale phase */
async function phase(text, duration, scale, bg) {
  if (stopRequested) return;

  label.textContent = text;
  circle.style.transitionDuration = duration + "s";
  circle.style.transform = `scale(${scale})`;
  circle.style.background = bg;

  await countdown(duration);
}

async function runExtendedExhale() {
  running = true;
  stopRequested = false;

  btnStart.style.display = "none";
  btnEndMid.style.display = "inline";

  await new Promise(res => setTimeout(res, 300));

  for (let r = 0; r < 2; r++) {
    if (stopRequested) break;

    /* Inhale 4s (shrink) */
    await phase("Inhale", 4, 0.75, "var(--small)");
    if (stopRequested) break;

    /* Exhale 6s (expand) */
    await phase("Exhale", 6, 1, "var(--big)");
    if (stopRequested) break;

    /* Small pause */
    await new Promise(res => setTimeout(res, 400));
  }

  resetToStart();
}

function resetToStart() {
  running = false;
  stopRequested = false;

  circle.style.transform = "scale(1)";
  circle.style.background = "var(--big)";
  label.textContent = "Inhale";
  number.textContent = "4";

  btnEndMid.style.display = "none";
  btnStart.style.display = "inline";
}

btnStart.addEventListener("click", () => {
  if (!running) runExtendedExhale();
});

btnEndMid.addEventListener("click", () => {
  stopRequested = true;
});
</script>

{% endblock %}
