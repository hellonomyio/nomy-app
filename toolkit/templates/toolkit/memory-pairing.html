{% extends "base.html" %}
{% load static %}
{% block title %}Memory Pairing{% endblock %}
{% block content %}
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet" />

<style>
:root {
  --ink:#1f003d;
  --muted:#5e4f79;
  --shadow:0 18px 40px rgba(17,12,40,.08);
  --radius:26px;
  --pill:#e9f0fa;
  --tile:#564d74;
}

*{box-sizing:border-box;margin:0;padding:0;}
body{
  font-family:'DM Sans',system-ui,-apple-system,'Segoe UI',Roboto,Arial,sans-serif;
  color:var(--ink);
  background: radial-gradient(circle at 50% 35%, #f9fbff 0%, #ffffff 90%);
  display:flex;
  flex-direction:column;
  align-items:center;
  min-height:100vh;
  overflow:hidden;
}

.back-btn {
  position: fixed;
  top: 84px;
  left: 28px;
  text-decoration: none;
  font-size: 15px;
  color: #3a2c6b;
  background: #fff;
  border: 1px solid #e6e0f5;
  border-radius: 999px;
  padding: 8px 16px;
  box-shadow: 0 6px 22px rgba(19,7,63,.06);
  transition: transform .1s ease;
  z-index: 2000;
}
.back-btn:hover { transform: translateY(-2px); }

.zoom-wrapper{
  transform:scale(0.85);
  transform-origin:top center;
  width:100%;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  text-align:center;
  gap:30px;
}

.oval{
  display:flex;
  align-items:center;
  justify-content:center;
  background:var(--pill);
  color:var(--ink);
  border-radius:var(--radius);
  height:70px;
  width:240px;
  font-size:19px;
  font-weight:500;
  box-shadow:var(--shadow);
}

.sub{
  font-size:17px;
  color:var(--muted);
  max-width:560px;
  line-height:1.6;
}

#countdown {
  font-size: 22px;
  font-weight: 700;
  margin-top: -10px;
}

.grid{
  display:grid;
  grid-template-columns:repeat(4,80px);
  grid-gap:20px;
  justify-content:center;
}

.tile{
  width:80px;
  height:80px;
  border-radius:50%;
  background:var(--tile);
  cursor:pointer;
  transition:background .4s ease, transform .2s ease;
}

.tile.revealed{ transform:scale(1.05); }

button{
  background:none;
  border:none;
  font-size:17px;
  font-weight:600;
  cursor:pointer;
}

@media(max-width:720px){
  .zoom-wrapper{transform:scale(1);}
}
</style>

<a href="{% url 'toolkit:toolkit-puzzles' %}" class="back-btn">← Puzzles</a>

<div class="zoom-wrapper">
  <div class="oval">Memory Pairing</div>
  <p id="instructions" class="sub">When you’re ready, tap “Reveal pattern”.</p>
  <p id="countdown"></p>

  <div class="grid" id="grid"></div>

  <button id="revealBtn">Reveal pattern</button>
</div>

<script>
const baseColours = [
  "#5ce1e6", "#e2a9f1", "#bf7e74", "#f38c7f",
  "#ffde59", "#ff66c4", "#ffbd59", "#38b6ff"
];

let tileset = [];
let first = null, second = null, locked = false, previewing = false;

const grid = document.getElementById("grid");
const instr = document.getElementById("instructions");
const countdownEl = document.getElementById("countdown");
const revealBtn = document.getElementById("revealBtn");

function createShuffledTiles(){
  tileset = [...baseColours, ...baseColours].sort(()=>Math.random()-0.5);
}

function createTiles(){
  grid.innerHTML = "";
  tileset.forEach(c=>{
    const t = document.createElement("div");
    t.className = "tile";
    t.dataset.color = c;
    grid.appendChild(t);
  });
}

function startPreview(){
  previewing = true;
  locked = true;
  const tiles = document.querySelectorAll(".tile");

  tiles.forEach(t=>t.style.background=t.dataset.color);
  instr.textContent = "Here’s your pattern. Take a moment to notice the colours and where they sit.";

  let count = 3;
  countdownEl.textContent = "3";

  const timer = setInterval(()=>{
    count--;
    if(count>0){
      countdownEl.textContent = count;
    } else {
      clearInterval(timer);
      countdownEl.textContent = "";
      tiles.forEach(t=>t.style.background="var(--tile)");
      instr.textContent = "Now, try to match the colours from memory.";
      locked = false;
      previewing = false;
      enablePlay();
    }
  },1000);
}

function enablePlay(){
  document.querySelectorAll(".tile").forEach(t=>{
    t.onclick = ()=>{
      if(locked || previewing || t.classList.contains("matched") || t===first) return;
      t.style.background=t.dataset.color;
      t.classList.add("revealed");
      if(!first){ first=t; }
      else { second=t; checkMatch(); }
    };
  });
}

function checkMatch(){
  locked=true;
  if(first.dataset.color===second.dataset.color){
    first.classList.add("matched");
    second.classList.add("matched");
    resetPick();
    checkFinished();
  } else {
    setTimeout(()=>{
      first.style.background="var(--tile)";
      second.style.background="var(--tile)";
      first.classList.remove("revealed");
      second.classList.remove("revealed");
      resetPick();
    },900);
  }
}

function resetPick(){
  [first,second,locked]=[null,null,false];
}

function checkFinished(){
  const allMatched=[...document.querySelectorAll(".tile")]
    .every(t=>t.classList.contains("matched"));

  if(allMatched){
    instr.textContent="Well done. You moved through that at your own pace.";
    revealBtn.textContent="Restart";
    revealBtn.style.display="inline";
    revealBtn.onclick=startGame;
  }
}

function startGame(){
  first=second=null;
  locked=previewing=false;
  instr.textContent="When you’re ready, tap “Reveal pattern”.";
  countdownEl.textContent="";
  createShuffledTiles();
  createTiles();
  revealBtn.textContent="Reveal pattern";
  revealBtn.onclick=()=>{ revealBtn.style.display="none"; startPreview(); };
}

window.onload=startGame;
</script>

{% endblock %}
