{% extends "base.html" %}
{% load static %}

{% block title %}Reflections{% endblock %}

{% block content %}

<style>
  #week-page,
  #week-page * {
    box-sizing: border-box;
    font-family: "DM Sans", sans-serif;
  }

  #week-page {
    position: relative;
    min-height: 100vh;
    padding: 90px 20px 80px;
    background: #ffffff;
    color: #1b1230;
  }

  /* MAIN PAGE HEADING */
  .week-main-title {
    font-size: 26px;
    font-weight: 800;
    text-align: center;
    margin-bottom: 24px;
    color: #2e2840;
  }

  .week-back-btn {
    position: fixed;
    top: 84px;
    left: 28px;
    text-decoration: none;
    font-size: 15px;
    color: #3a2c6b;
    background: #fff;
    border: 1px solid #e6e0f5;
    border-radius: 999px;
    padding: 8px 16px;
    box-shadow: 0 6px 22px rgba(19,7,63,.06);
    z-index: 2500;
  }

  .week-progress {
    position: fixed;
    top: 120px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 6px;
    width: min(320px, 80vw);
    z-index: 1400;
  }

  .week-bar {
    flex: 1;
    height: 5px;
    background: #e9e6f7;
    border-radius: 999px;
    overflow: hidden;
  }

  .week-bar__fill {
    height: 100%;
    width: 0%;
    background: #22163c;
    border-radius: inherit;
    transition: width .25s ease;
  }

  .week-slides {
    width: min(820px, 94vw);
    margin: 40px auto 0;
  }

  .week-slide { display: none; animation: fade .25s ease; }
  .week-slide.is-active { display: block; }

  @keyframes fade {
    from { opacity: 0; transform: translateY(6px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  .week-card {
    background: #f5f4fc;
    border-radius: 24px;
    box-shadow: 0 18px 40px rgba(17,12,40,.10);
    padding: 22px 22px 28px;
  }

  .week-card-day {
    font-size: 17px;
    font-weight: 700;
    color: #3f335a;
    margin-bottom: 18px;
  }

  .emotion-chip {
    display: inline-flex;
    align-items: center;
    padding: 6px 14px;
    border-radius: 999px;
    font-size: 13px;
    font-weight: 600;
    margin-bottom: 8px;
    margin-top: 15px;
  }

  .chip-energised { background:#f4f8f3; color:#1a3a1f; }
  .chip-pleasant  { background:#fffaeb; color:#4a3600; }
  .chip-low-energy { background:#e9f0fa; color:#002f5f; }
  .chip-vulnerable { background:#f1eeff; color:#2a1455; }

  .week-section { margin-top: 18px; }

  .week-chip {
    display: inline-flex;
    padding: 4px 10px;
    border-radius: 999px;
    background: #f1f1ff;
    font-size: 13px;
    font-weight: 500;
    color: #1f003d;
  }

  /* Emotionize Reflections pill */
  .week-chip.emotionize {
    background: #e9c3f1 !important;
    font-size: 15px;
    padding: 8px 16px;
    font-weight: 500;
    display: inline-flex;
  }

  .week-section-body {
    font-size: 15px;
    line-height: 1.55;
    color: #1b1230;
    white-space: pre-wrap;
  }

  .week-section-body.checklist-body {
    white-space: normal;
    margin-top: 4x;
    margin-bottom: 6px;
  }

  /* Checklist spacing */
  .checklist-item {
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    user-select: none;
  }

  .checkmark {
    font-size: 16px;
    width: 20px;
    text-align: center;
  }

  .week-footer {
    position: fixed;
    bottom: 14px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 13px;
    color: #6b647d;
  }

  /* Keep your tap overlay for layout, but don't let it steal taps */
  .week-tap { pointer-events: none; }

  /* ---- ACCORDION (layout only) ---- */
  .acc {
    border: 1px solid rgba(34,22,60,.08);
    border-radius: 18px;
    background: rgba(255,255,255,.5);
    overflow: hidden;
    margin-top: 12px;
  }

  .acc-head {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    padding: 12px 14px;
    background: transparent;
    border: 0;
    cursor: pointer;
    text-align: left;
  }

  .acc-icon {
    width: 26px;
    height: 26px;
    border-radius: 999px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: rgba(34,22,60,.08);
    color: #22163c;
    font-weight: 800;
    flex: 0 0 auto;
  }

  .acc-body {
    display: none;
    padding: 0 14px 14px;
  }

  .acc.is-open .acc-body { display: block; }

  .acc.is-open .acc-icon::before { content: "−"; }
  .acc:not(.is-open) .acc-icon::before { content: "+"; }

  .acc-chiprow {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .week-chip.express {
  background: #e1dcf9 !important;
  font-size: 15px;
  padding: 8px 16px;
  font-weight: 500;
  display: inline-flex;
  color: #1f003d;
}
</style>

<a href="{% url 'dailies:dailies-home' %}" class="week-back-btn">← Dailies Menu</a>

<div id="week-page">

  <div class="week-main-title">Reflections</div>

  <div class="week-progress" id="weekProgress"></div>

  <section class="week-slides" id="weekSlides"></section>

  <div class="week-tap" aria-hidden="true"
       style="position:fixed; inset:0; display:grid; grid-template-columns:1fr 1fr; z-index:2000;">
    <div id="tapLeft"></div>
    <div id="tapRight"></div>
  </div>

  <div class="week-footer">Reflections • Tap left/right</div>
</div>

<script>

  const slidesContainer = document.getElementById("weekSlides");
  const progressRoot = document.getElementById("weekProgress");
  
  const dailies = JSON.parse(localStorage.getItem("nomy_dailies") || "[]");
  let emotionReflections = [];
  const expressReflections = JSON.parse(localStorage.getItem("nomy_express_reflections") || "[]");
  
  {% if user.is_authenticated %}
  
  fetch("/reflections/get/emotion/")
      .then(r => r.json())
      .then(data => {
          emotionReflections = data;
          buildReflections();
      });
  
  {% else %}
  
  emotionReflections = JSON.parse(localStorage.getItem("nomy_emotion_reflections") || "[]");
  buildReflections();
  
  {% endif %}
  
  function buildReflections() {
  
    const all = [...dailies, ...emotionReflections, ...expressReflections];
  
    function parseUK(d){
      const [day,month,year] = d.split("/").map(Number);
      return new Date(year,month-1,day);
    }
  
    const grouped = {};
    all.forEach(e=>{
      if(!e.date) return;
      if(!grouped[e.date])
        grouped[e.date] = { affirm:[], goals:[], reflections:[], emotions:[], checklist:[], express:[], express_audio:[]};
  
      if(e.affirmation) grouped[e.date].affirm.push(e.affirmation);
      if(e.goal) grouped[e.date].goals.push(e.goal);
      if(e.reflection) grouped[e.date].reflections.push(e.reflection);
      if(e.emotion) grouped[e.date].emotions.push(e.emotion);
      if(e.checklist) grouped[e.date].checklist = e.checklist;
      if(e.express) grouped[e.date].express.push(e.express);
      if(e.express_audio) {
        grouped[e.date].express_audio = grouped[e.date].express_audio || [];
        grouped[e.date].express_audio.push(e.express_audio);
      }
    });
  
    const sorted = Object.keys(grouped).sort((a,b)=>parseUK(b)-parseUK(a));
  
    function formatDate(d){
      const [day,month,year] = d.split("/").map(Number);
      return new Date(year,month-1,day).toLocaleDateString("en-GB",
        {weekday:"long", day:"numeric", month:"long"});
    }
  
    const MAP = {
      excitement:"energised", curiosity:"energised", anxiety:"energised", frustration:"energised",
      relief:"pleasant", happiness:"pleasant", amusement:"pleasant", contentment:"pleasant",
      exhaustion:"low-energy", numbness:"low-energy", sadness:"low-energy", overwhelm:"low-energy", uncertainty:"low-energy",
      shame:"vulnerable", embarrassment:"vulnerable", loneliness:"vulnerable", confusion:"vulnerable", stupidity:"vulnerable"
    };
  
    function makeChip(emotion){
      const cat = MAP[emotion] || "low-energy";
      const cap = emotion.charAt(0).toUpperCase() + emotion.slice(1);
      return `<div class="emotion-chip chip-${cat}">${cap}</div>`;
    }
  
    function accBlock(titleChipHtml, bodyHtml, open=false) {
      return `
        <div class="acc${open ? " is-open" : ""}">
          <button type="button" class="acc-head">
            <span class="acc-chiprow">${titleChipHtml}</span>
            <span class="acc-icon" aria-hidden="true"></span>
          </button>
          <div class="acc-body">${bodyHtml}</div>
        </div>
      `;
    }
  
    sorted.forEach((date, idx)=>{
      const e = grouped[date];
      const pretty = formatDate(date);
  
      const affBlock = e.affirm.length
        ? accBlock(
            `<div class="week-chip">Affirmations</div>`,
            `<div class="week-section-body">${e.affirm.join("<br><br>")}</div>`
          )
        : "";
  
        let expressCombinedBlock = "";
        if (e.express.length || e.express_audio.length) {
  
          let inside = "";
  
          if (e.express.length) {
            inside += `
              <div class="week-section-body" style="margin-bottom:12px;">
                ${e.express.join("<br><br>")}
              </div>
            `;
          }
  
          if (e.express_audio.length) {
            inside += `
              <div class="week-section-body" style="margin-top:12px;">
                ${e.express_audio
                  .map(src => `<audio controls src="${src}" style="width:100%; margin-bottom:16px;"></audio>`)
                  .join("")}
              </div>
            `;
          }
  
          expressCombinedBlock = accBlock(
            `<div class="week-chip express">Express</div>`,
            inside
          );
        }
  
      const goalBlock = e.goals.length
        ? accBlock(
            `<div class="week-chip">Goals</div>`,
            `<div class="week-section-body">${e.goals.join("<br><br>")}</div>`
          )
        : "";
  
      const checklistBlock = e.checklist && e.checklist.length
        ? accBlock(
            `<div class="week-chip">Checklist</div>`,
            `<div class="week-section-body checklist-body" data-date="${date}">
               ${e.checklist.map((item, idx2) =>
                 `<div class="checklist-item" data-date="${date}" data-idx="${idx2}">
                    <span class="checkmark">${item.checked ? "✔" : "◻"}</span>
                    <span>${item.text}</span>
                  </div>`
               ).join("")}
             </div>`
          )
        : "";
  
      let emotionBlocks = "";
      if (e.emotions.length) {
        const body = e.emotions.map((em, index) => `
          ${makeChip(em)}
          <div class="week-section-body">${e.reflections[index] || ""}</div>
        `).join("");
        emotionBlocks = accBlock(
          `<div class="week-chip emotionize">Emotionize</div>`,
          body
        );
      }
  
      const html = `
        <article class="week-slide${idx===0?" is-active":""}">
          <div class="week-card">
            <div class="week-card-day">${pretty}</div>
  
            <div class="week-section">
              ${affBlock}
              ${goalBlock}
              ${checklistBlock}
              ${emotionBlocks}
              ${expressCombinedBlock}
            </div>
          </div>
        </article>
      `;
      slidesContainer.insertAdjacentHTML("beforeend", html);
  
      const bar=document.createElement("div");
      bar.className="week-bar";
      const fill=document.createElement("div");
      fill.className="week-bar__fill";
      bar.appendChild(fill);
      progressRoot.appendChild(bar);
    });
  
    const slides=[...document.querySelectorAll(".week-slide")];
    const fills=[...document.querySelectorAll(".week-bar__fill")];
    let i=0;
  
    function render(n){
      i=Math.max(0,Math.min(slides.length-1,n));
      slides.forEach((s,idx)=>s.classList.toggle("is-active",idx===i));
      fills.forEach((f,idx)=>f.style.width=idx<=i?"100%":"0%");
    }
  
    document.addEventListener("click", (ev)=>{
      if(ev.target.closest(".acc-head")){
        ev.target.closest(".acc").classList.toggle("is-open");
      }
    });
  
    window.addEventListener("keydown",e=>{
      if(e.key==="ArrowRight") render(i+1);
      if(e.key==="ArrowLeft") render(i-1);
    });
  
    render(0);
  
  } // end buildReflections()
  
  </script>
  

{% endblock %}
