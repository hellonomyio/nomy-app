{% extends "base.html" %}
{% load static %}

{% block title %}Reflections{% endblock %}

{% block content %}

<style>
  #week-page,
  #week-page * {
    box-sizing: border-box;
    font-family: "DM Sans", sans-serif;
  }

  #week-page {
    position: relative;
    min-height: 100vh;
    padding: 90px 20px 80px;
    background: #ffffff;
    color: #1b1230;
  }

  /* MAIN PAGE HEADING */
  .week-main-title {
    font-size: 26px;
    font-weight: 800;
    text-align: center;
    margin-bottom: 24px;
    color: #2e2840;
  }

  .week-back-btn {
    position: fixed;
    top: 84px;
    left: 28px;
    text-decoration: none;
    font-size: 15px;
    color: #3a2c6b;
    background: #fff;
    border: 1px solid #e6e0f5;
    border-radius: 999px;
    padding: 8px 16px;
    box-shadow: 0 6px 22px rgba(19,7,63,.06);
    z-index: 2500;
  }

  .week-progress {
    position: fixed;
    top: 120px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 6px;
    width: min(320px, 80vw);
    z-index: 1400;
  }

  .week-bar {
    flex: 1;
    height: 5px;
    background: #e9e6f7;
    border-radius: 999px;
    overflow: hidden;
  }

  .week-bar__fill {
    height: 100%;
    width: 0%;
    background: #22163c;
    border-radius: inherit;
    transition: width .25s ease;
  }

  .week-slides {
    width: min(820px, 94vw);
    margin: 40px auto 0;
  }

  .week-slide { display: none; animation: fade .25s ease; }
  .week-slide.is-active { display: block; }

  @keyframes fade {
    from { opacity: 0; transform: translateY(6px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  .week-card {
    background: #f5f4fc;
    border-radius: 24px;
    box-shadow: 0 18px 40px rgba(17,12,40,.10);
    padding: 22px 22px 28px;
  }

  .week-card-day {
    font-size: 17px;
    font-weight: 700;
    color: #3f335a;
    margin-bottom: 18px;
  }

  .emotion-chip {
    display: inline-flex;
    align-items: center;
    padding: 6px 14px;
    border-radius: 999px;
    font-size: 13px;
    font-weight: 600;
    margin-bottom: 8px;
    margin-top: 15px;
  }

  .chip-energised { background:#f4f8f3; color:#1a3a1f; }
  .chip-pleasant  { background:#fffaeb; color:#4a3600; }
  .chip-low-energy { background:#e9f0fa; color:#002f5f; }
  .chip-vulnerable { background:#f1eeff; color:#2a1455; }

  .week-section { margin-top: 18px; }

  .week-chip {
    display: inline-flex;
    padding: 4px 10px;
    border-radius: 999px;
    background: #e1dcf9;
    font-size: 13px;
    font-weight: 500;
    color: #1f003d;
    margin-bottom: 6px;
  }

  /* Emotionize Reflections pill */
  .week-chip.emotionize {
    background: #e9c3f1 !important;
    font-size: 15px;
    padding: 8px 16px;
    font-weight: 700;
    display: block;
    width: fit-content;
    margin-bottom: 16px; /* space before first emotion */
  }

  .week-section-body {
    font-size: 15px;
    line-height: 1.55;
    color: #1b1230;
    white-space: pre-wrap;
  }

  .week-section-body.checklist-body {
    white-space: normal;
    margin-top: 4x;      /* space above checklist items */
    margin-bottom: 6px;   /* space under checklist items */
  }


  /* Checklist spacing */
  .checklist-item {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .checkmark {
    font-size: 16px;
    width: 20px;
    text-align: center;
  }

  .week-footer {
    position: fixed;
    bottom: 14px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 13px;
    color: #6b647d;
  }
</style>

<a href="{% url 'dailies:dailies-home' %}" class="week-back-btn">← Back to Dailies Menu</a>

<div id="week-page">

  <div class="week-main-title">Reflections</div>

  <div class="week-progress" id="weekProgress"></div>

  <section class="week-slides" id="weekSlides"></section>

  <div class="week-tap" aria-hidden="true"
       style="position:fixed; inset:0; display:grid; grid-template-columns:1fr 1fr; z-index:2000;">
    <div id="tapLeft"></div>
    <div id="tapRight"></div>
  </div>

  <div class="week-footer">Reflections • Tap left/right</div>
</div>

<script>
  const slidesContainer = document.getElementById("weekSlides");
  const progressRoot = document.getElementById("weekProgress");

  const dailies = JSON.parse(localStorage.getItem("nomy_dailies") || "[]");
  const emotionReflections = JSON.parse(localStorage.getItem("nomy_emotion_reflections") || "[]");

  const all = [...dailies, ...emotionReflections];

  function parseUK(d){
    const [day,month,year] = d.split("/").map(Number);
    return new Date(year,month-1,day);
  }

  const grouped = {};
  all.forEach(e=>{
    if(!e.date) return;
    if(!grouped[e.date])
      grouped[e.date] = { affirm:[], goals:[], reflections:[], emotions:[], checklist:[] };

    if(e.affirmation) grouped[e.date].affirm.push(e.affirmation);
    if(e.goal) grouped[e.date].goals.push(e.goal);
    if(e.reflection) grouped[e.date].reflections.push(e.reflection);
    if(e.emotion) grouped[e.date].emotions.push(e.emotion);
    if(e.checklist) grouped[e.date].checklist = e.checklist;
  });

  const sorted = Object.keys(grouped).sort((a,b)=>parseUK(b)-parseUK(a));

  function formatDate(d){
    const [day,month,year] = d.split("/").map(Number);
    return new Date(year,month-1,day).toLocaleDateString("en-GB",
      {weekday:"long", day:"numeric", month:"long"});
  }

  const MAP = {
    excitement:"energised", curiosity:"energised", anxiety:"energised", frustration:"energised",
    relief:"pleasant", happiness:"pleasant", amusement:"pleasant", contentment:"pleasant",
    exhaustion:"low-energy", numbness:"low-energy", sadness:"low-energy", overwhelm:"low-energy", uncertainty:"low-energy",
    shame:"vulnerable", embarrassment:"vulnerable", loneliness:"vulnerable", confusion:"vulnerable", stupidity:"vulnerable"
  };

  function makeChip(emotion){
    const cat = MAP[emotion] || "low-energy";
    const cap = emotion.charAt(0).toUpperCase() + emotion.slice(1);
    return `<div class="emotion-chip chip-${cat}">${cap}</div>`;
  }

  sorted.forEach((date, idx)=>{
    const e = grouped[date];
    const pretty = formatDate(date);

    /* Build grouped Emotionize Reflections section */
    let emotionBlocks = "";
    if (e.emotions.length) {
      emotionBlocks += `
        <div class="week-section">
          <div class="week-chip emotionize">Emotionize Reflections</div>
      `;
      e.emotions.forEach((em, index)=>{
        emotionBlocks += `
          ${makeChip(em)}
          <div class="week-section-body">${e.reflections[index] || ""}</div>
        `;
      });
      emotionBlocks += `</div>`;
    }

    const affBlock = e.affirm.length
      ? `<div class="week-section">
           <div class="week-chip">Affirmations</div>
           <div class="week-section-body">${e.affirm.join("<br><br>")}</div>
         </div>` : "";

    const goalBlock = e.goals.length
      ? `<div class="week-section">
           <div class="week-chip">Goals</div>
           <div class="week-section-body">${e.goals.join("<br><br>")}</div>
         </div>` : "";

    const checklistBlock = e.checklist && e.checklist.length
      ? `<div class="week-section">
           <div class="week-chip">Checklist</div>
           <div class="week-section-body checklist-body">
             ${e.checklist.map(item =>
               `<div class="checklist-item">
                  <span class="checkmark">${item.checked ? "✔" : "◻"}</span>
                  <span>${item.text}</span>
                </div>`
             ).join("")}
           </div>
         </div>`
      : "";

    const html = `
      <article class="week-slide${idx===0?" is-active":""}">
        <div class="week-card">
          <div class="week-card-day">${pretty}</div>
          ${affBlock}
          ${goalBlock}
          ${checklistBlock}
          ${emotionBlocks}
        </div>
      </article>
    `;
    slidesContainer.insertAdjacentHTML("beforeend", html);

    const bar=document.createElement("div");
    bar.className="week-bar";
    const fill=document.createElement("div");
    fill.className="week-bar__fill";
    bar.appendChild(fill);
    progressRoot.appendChild(bar);
  });

  const slides=[...document.querySelectorAll(".week-slide")];
  const fills=[...document.querySelectorAll(".week-bar__fill")];
  let i=0;

  function render(n){
    i=Math.max(0,Math.min(slides.length-1,n));
    slides.forEach((s,idx)=>s.classList.toggle("is-active",idx===i));
    fills.forEach((f,idx)=>f.style.width=idx<=i?"100%":"0%");
  }

  document.getElementById("tapLeft").onclick=()=>render(i-1);
  document.getElementById("tapRight").onclick=()=>render(i+1);

  window.addEventListener("keydown",e=>{
    if(e.key==="ArrowRight") render(i+1);
    if(e.key==="ArrowLeft") render(i-1);
  });

  let startX=null;
  window.addEventListener("touchstart", e=>startX=e.touches[0].clientX,{passive:true});
  window.addEventListener("touchend", e=>{
    const dx=e.changedTouches[0].clientX-startX;
    if(Math.abs(dx)>40) dx<0?render(i+1):render(i-1);
  });

  render(0);
</script>

{% endblock %}
