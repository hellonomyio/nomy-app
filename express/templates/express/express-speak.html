{% extends "base.html" %}
{% load static %}
{% block title %}Express • Speak{% endblock %}

{% block content %}
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet" />

<style>
:root {
  --bg:#ffffff;
  --ink:#1f003d;
  --muted:#5e4f79;
  --wave:#b3b0f8;
  --pill:#e1dcf9;
  --shadow:0 18px 40px rgba(17,12,40,.10);
  --radius:26px;
}

/* scope all styles */
.express-speak-page {
  background: var(--bg);
  color: var(--ink);
  font-family: 'DM Sans', system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  min-height: calc(100vh - 60px);
  /* ↓ slightly reduced vertical padding to lift content */
  padding: 90px 20px 80px;
  text-align: center;
}

/* back button */
.express-speak-page .back-btn {
  position: fixed;
  top: 72px; /* slightly higher */
  left: 28px;
  text-decoration: none;
  font-size: 15px;
  font-weight: 400;
  color: #3a2c6b;
  background: #fff;
  border: 1px solid #e6e0f5;
  border-radius: 999px;
  padding: 8px 16px;
  box-shadow: 0 6px 22px rgba(19,7,63,.06);
  transition: transform .1s ease, box-shadow .2s ease, background .2s ease;
  z-index: 2000;
}
.express-speak-page .back-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 12px 28px rgba(19,7,63,.10);
  background: #faf7ff;
}

/* response quote (from previous page) */
.express-speak-page .response-text {
  font-size: clamp(20px, 2.2vw, 26px);
  font-weight: 400;
  line-height: 1.4;
  color: var(--ink);
  max-width: 720px;
  text-align: center;
  position: relative;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
  padding: 0 24px;
  margin-bottom: 50px; /* slightly tighter spacing */
}
.express-speak-page .response-text::before {
  content: "“";
  font-size: 40px;
  color: var(--muted);
  position: absolute;
  left: -4px;
  top: -10px;
}
.express-speak-page .response-text::after {
  content: "”";
  font-size: 40px;
  color: var(--muted);
  position: absolute;
  right: -4px;
  bottom: -10px;
}

/* wave animation */
.express-speak-page .wave {
  width: 220px;
  height: 60px;
  background: linear-gradient(to right, var(--wave), transparent);
  mask: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 40"><path fill="black" d="M0 20 Q5 10 10 20 T20 20 T30 20 T40 20 T50 20 T60 20 T70 20 T80 20 T90 20 T100 20 T110 20 T120 20 T130 20 T140 20 T150 20 T160 20 T170 20 T180 20 T190 20 T200 20"/></svg>') center/contain repeat-x;
  mask-repeat: repeat-x;
  animation: pulse 1.2s ease-in-out infinite;
  margin: 55px auto; /* reduced from 70px */
}
@keyframes pulse {
  0%, 100% { opacity: .6; transform: scaleY(0.9); }
  50% { opacity: 1; transform: scaleY(1.1); }
}

/* buttons + footer */
.express-speak-page .footer {
  margin-top: auto;
  font-size: 16px;
  color: var(--ink);
}
.express-speak-page .hidden { display: none; }
.express-speak-page button {
  background: none;
  border: none;
  color: var(--ink);
  font-weight: 600;
  font-size: 16px;
  cursor: pointer;
  margin-top: 36px;
}
.express-speak-page button:hover { text-decoration: underline; }

@media(max-width:720px){
  .express-speak-page { padding-top: 80px; }
  .express-speak-page .back-btn {
    top: 68px;
    left: 18px;
    font-size: 14px;
    padding: 6px 12px;
  }
}
</style>

<div class="express-speak-page">
  <a href="javascript:history.back()" class="back-btn">← Back to Response</a>

  {% if response %}
    <h2 class="response-text">{{ response }}</h2>
  {% endif %}

  <!-- Screen 1 -->
  <section id="record-screen">
    <p>Speak at your own pace. You can pause or start over anytime.</p>

    <div class="wave" id="wave"></div>

    <p class="footer">Go at your own pace. You’re exploring how your voice feels when it’s yours.</p>

    <button id="startBtn">Start Recording</button>
  </section>

  <!-- Screen 2 -->
  <section id="done-screen" class="hidden">
    <div class="pill">Express</div>
    <p>You did it! You expressed your truth in your own way. Take a moment to notice how that felt.</p>

    <audio id="player" controls style="margin-top:40px;"></audio>

    <button id="endBtn">End session</button>
  </section>
</div>

<script>
let mediaRecorder;
let chunks = [];

const recordScreen = document.getElementById('record-screen');
const doneScreen = document.getElementById('done-screen');
const player = document.getElementById('player');
const startBtn = document.getElementById('startBtn');
const endBtn = document.getElementById('endBtn');

startBtn.onclick = async () => {
  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  mediaRecorder = new MediaRecorder(stream);
  chunks = [];
  mediaRecorder.start();

  document.getElementById('wave').style.animationPlayState = 'running';
  startBtn.textContent = 'Recording... click to stop';

  startBtn.onclick = () => {
    mediaRecorder.stop();
    stream.getTracks().forEach(t => t.stop());
  };

  mediaRecorder.ondataavailable = e => chunks.push(e.data);
  mediaRecorder.onstop = () => {
    const blob = new Blob(chunks, { type: 'audio/webm' });
    const url = URL.createObjectURL(blob);
    player.src = url;

    recordScreen.classList.add('hidden');
    doneScreen.classList.remove('hidden');
  };
};

endBtn.onclick = () => {
  window.location.href = "{% url 'express:express-home' %}";
};
</script>
{% endblock %}
