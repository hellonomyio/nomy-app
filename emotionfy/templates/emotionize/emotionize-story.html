{% extends "base.html" %}
{% load static %}
{% block title %}Emotionize – {{ title }}{% endblock %}
{% block content %}

<style>
  :root{
    --bg:#ffffff;
    --ink:#1b1230;
    --muted:#3f335a;
    --active:#22163c;
    --inactive:#e9e6f7;
    --pill-bg:#f4f5f7;
  }

  *{box-sizing:border-box;}

  html,body{
    height:100%;
    margin:0;
    background:var(--bg);
    color:var(--ink);
    font-family:'DM Sans',system-ui,-apple-system,'Segoe UI',Roboto,Arial,sans-serif;
    overflow:hidden;
  }

  .story{
    position:relative;
    height:100vh;
    display:flex;
    flex-direction:column;
    align-items:center;
    padding-top:140px;
  }

  /* TOP PILL */
  #stage-pill{
    background:var(--pill-bg);
    color:var(--active);
    font-size:clamp(18px,2.5vw,24px);
    padding:16px 44px;
    border-radius:999px;
    box-shadow:0 8px 24px rgba(0,0,0,.04);
    margin-bottom:40px;
    text-align:center;
  }

  #stage-pill.energised  { background:#f4f8f3; }
  #stage-pill.pleasant   { background:#fffaeb; }
  #stage-pill.low-energy { background:#e9f0fa; }
  #stage-pill.vulnerable { background:#f1eeff; }

  /* PROGRESS BAR */
  .story__progress{
    position:fixed;
    top:90px;
    left:50%;
    transform:translateX(-50%);
    display:flex;
    gap:8px;
    width:min(280px,60vw);
    z-index:5;
  }
  .bar{
    flex:1;
    height:6px;
    background:var(--inactive);
    border-radius:999px;
    overflow:hidden;
  }
  .bar__fill{
    height:100%;
    width:0%;
    background:var(--active);
    border-radius:inherit;
    transition:width .25s ease;
  }

  /* SLIDES */
  .slides{
    width:min(800px,90vw);
    height:calc(100vh - 300px);
    position:relative;
    overflow:hidden;
  }

  .slide{
    position:absolute;
    top:0;
    left:0;
    width:100%;
    height:100%;
    padding:20px 0 120px;
    display:none;
    flex-direction:column;
    align-items:center;
    text-align:center;
    overflow-y:auto;
    animation:fade .25s ease;
  }

  .slide.is-active{display:flex;}

  @keyframes fade{
    from{opacity:.001; transform:translateY(6px);}
    to{opacity:1; transform:none;}
  }

  .lead{
    font-size:clamp(22px,3.2vw,36px);
    font-weight:700;
    margin-bottom:20px;
    max-width:28ch;
  }
  .sub{
    font-size:clamp(12px,1vw,16px);
    line-height:1.7;
    max-width:80ch;
    margin-bottom:20px;
  }

  /* SINGLE FLOATING BUTTON */
  #floating-next{
    position:fixed;
    bottom:90px;
    left:50%;
    transform:translateX(-50%);
    padding:14px 30px;
    min-width:220px;
    text-align:center;

    display:flex;
    align-items:center;
    justify-content:center;
    gap:10px;

    background:var(--pill-bg);
    border-radius:999px;
    font-size:1rem;
    font-weight:500;
    color:var(--active);
    box-shadow:0 10px 30px rgba(0,0,0,.08);

    border:none;
    cursor:pointer;
    transition:background .2s ease;
    z-index:999;
  }

  #floating-next::after{
    content:"→";
    opacity:.7;
    font-size:1.1rem;
  }

  #floating-next.last-slide::after{
    content:"";
  }

  #floating-next:hover{
    background:#ececf5;
  }

  .tap{
    position:fixed;
    inset:0;
    display:grid;
    grid-template-columns:1fr 1fr;
    z-index:3;
  }

  .tap button{
    background:none;
    border:none;
    cursor:pointer;
  }

  .footer{
    position:fixed;
    bottom:5px;
    left:50%;
    transform:translateX(-50%);
    font-size:14px;
    color:var(--muted);
  }

  /* MATCHING BACK BUTTON */
  .back-btn{
    position:fixed;
    top:70px;
    left:28px;
    background:#fff;
    border:1px solid #e6e0f5;
    border-radius:999px;
    padding:8px 16px;
    font-size:15px;
    color:#3a2c6b;
    text-decoration:none;
    box-shadow:0 6px 22px rgba(19,7,63,.06);
    z-index:2000;
  }
</style>

<main class="story" aria-live="polite">

  <a href="{% url category_url_name %}" class="back-btn">
    ← {{ category|capfirst }} feelings
  </a>

  <div class="story__progress" id="progress"></div>

  <div id="stage-pill" class="{{ category }}" data-emotion="{{ emotion }}">
    {{ title }}
  </div>

  <section class="slides" id="slides">
    {% for s in slides %}
      <article class="slide{% if forloop.first %} is-active{% endif %}">
        {% if s.lead %}<p class="lead">{{ s.lead|safe }}</p>{% endif %}
        {% if s.sub %}<p class="sub">{{ s.sub|safe }}</p>{% endif %}
      </article>
    {% endfor %}
  </section>

  <button id="floating-next"></button>

  <div class="tap" aria-hidden="true">
    <button id="prev"></button>
    <button id="next"></button>
  </div>

  <div class="footer">{{ title|capfirst }} • Tip: press ← / → keys</div>
</main>


<script>
(function(){

  const slides = [...document.querySelectorAll('.slide')];
  const progressRoot = document.getElementById('progress');
  const stagePill = document.getElementById('stage-pill');
  const fbtn = document.getElementById('floating-next');

  const pillLabels = [
    "{{ title }}",
    "How it Shows Up",
    "Common Sources",
    "It Affects"
  ];

  const notes = [
    {% for s in slides %}
      "{{ s.note|default:'' }}",
    {% endfor %}
  ];

  for (let j=0; j<slides.length; j++){
    progressRoot.insertAdjacentHTML("beforeend",
      `<div class="bar"><div class="bar__fill"></div></div>`
    );
  }
  const fills = [...document.querySelectorAll('.bar__fill')];

  let i = 0;

  function updateUI(){
    stagePill.textContent = pillLabels[i];

    slides.forEach((s, idx) =>
      s.classList.toggle('is-active', idx === i)
    );

    fills.forEach((f, idx) =>
      f.style.width = idx <= i ? "100%" : "0%"
    );

    const isLast = i === slides.length - 1;

    if (isLast){
      fbtn.textContent = notes[i] || "Reflect";
      fbtn.classList.add("last-slide");
      fbtn.onclick = () => {
        window.location.href = "/emotionize/reflection/?emotion={{ emotion }}&category={{ category }}";
      };
    }
    else {
      fbtn.textContent = pillLabels[i+1];
      fbtn.classList.remove("last-slide");
      fbtn.onclick = () => go(i+1);
    }
  }

  function go(n){
    i = Math.max(0, Math.min(slides.length-1, n));
    updateUI();
  }

  document.getElementById('next').onclick = () => go(i+1);
  document.getElementById('prev').onclick = () => go(i-1);

  window.addEventListener("keydown", e => {
    if (e.key==="ArrowRight") go(i+1);
    if (e.key==="ArrowLeft") go(i-1);
  });

  let startX=null;
  window.addEventListener("touchstart", e => startX=e.touches[0].clientX, {passive:true});
  window.addEventListener("touchend", e => {
    if (startX==null) return;
    const dx=e.changedTouches[0].clientX-startX;
    if (Math.abs(dx)>40) (dx<0 ? go(i+1) : go(i-1));
    startX=null;
  });

  updateUI();

})();
</script>

{% endblock %}
